<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sedenioni v7.0 - Stable</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #1a1a1a; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* --- LAYOUT --- */
        #main-container { display: flex; width: 100vw; height: 100vh; overflow: hidden; position: relative; }
        
        #canvas-container {
            flex: 1; min-width: 0; position: relative;
            background-color: #1a1a1a;
            transition: background 0.5s ease;
        }

        /* --- SFONDI AMBIENTALI --- */
        .bg-default { background-color: #1a1a1a; }
        .bg-deep-space { background: radial-gradient(circle at center, #0b1026 0%, #000000 100%); }
        .bg-studio { background: radial-gradient(circle at center, #3a3a40 0%, #111 60%, #000 100%); }

        /* --- TOP BAR --- */
        #top-bar {
            position: absolute; top: 0; left: 0; right: 0;
            height: 60px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px;
            pointer-events: none; 
            z-index: 50;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }

        #top-bar > * { pointer-events: auto; }

        #main-title {
            color: white; font-size: 1.4em; font-weight: bold;
            text-shadow: 0 2px 4px black; margin: 0;
            text-align: center;
        }

        .bar-group { display: flex; gap: 10px; align-items: center; position: relative; }

        .ui-btn {
            width: 42px; height: 42px; 
            background: rgba(40, 40, 45, 0.8);
            border: 1px solid rgba(255,255,255,0.2); 
            border-radius: 8px;
            color: white; font-size: 20px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(4px); transition: 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .ui-btn:active { transform: scale(0.95); }
        .ui-btn.active { background: rgba(0, 136, 255, 0.8); border-color: #00aaff; color: white; }
        .icon-svg { width: 24px; height: 24px; fill: currentColor; }

        /* --- MENU IMPOSTAZIONI --- */
        #settings-menu {
            position: absolute; top: 55px; left: 0;
            background: rgba(30, 30, 35, 0.95);
            border: 1px solid #555; border-radius: 8px;
            padding: 15px; width: 220px;
            display: none; flex-direction: column; gap: 12px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
        }
        #settings-menu.visible { display: flex; }
        
        .setting-row { display: flex; justify-content: space-between; align-items: center; color: #ccc; font-size: 13px; }
        .setting-action { 
            background: #444; border: none; color: white; padding: 6px 10px; border-radius: 4px; cursor: pointer; flex: 1; margin-left: 5px;
            text-align: center; font-size: 12px;
        }
        #help-btn-trigger {
            background: #0088ff; color: white; border-radius: 50%; width: 24px; height: 24px; 
            padding: 0; display: flex; align-items: center; justify-content: center; 
            font-weight: bold; flex: 0 0 24px;
        }
        #help-btn-trigger:hover { background: #33aaff; transform: scale(1.1); }

        /* --- SIDEBAR --- */
        #sidebar {
            width: 0; 
            background: #202025;
            border-left: 1px solid #444;
            display: flex;
            flex-direction: column;
            transition: width 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            overflow: hidden;
            flex-shrink: 0;
            z-index: 100;
            position: relative;
        }
        #sidebar.open { width: 450px; }
        @media (max-width: 600px) {
            #sidebar.open { width: 100vw; position: absolute; height: 100%; right: 0; }
        }

        .sidebar-tabs {
            display: flex; background: #2a2a30; border-bottom: 1px solid #444;
            flex-shrink: 0; align-items: stretch;
        }
        .tab-btn {
            flex: 1; padding: 12px 5px; border: none; background: transparent;
            color: #888; cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent;
            transition: all 0.2s; font-size: 11px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .tab-btn.active { color: white; border-bottom: 3px solid #0088ff; background: #333; }
        
        #close-sidebar-btn {
            width: 30px; background: #cc3333; border: none; color: white;
            font-size: 18px; cursor: pointer;
        }

        .tab-content { flex: 1; overflow: hidden; display: none; flex-direction: column; }
        .tab-content.active { display: flex; }

        #triplets-scroll { flex: 1; overflow-y: auto; padding: 10px; }
        .triplets-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .triplet-btn {
            background: #333; color: #aaa; border: 1px solid #555;
            border-radius: 4px; padding: 10px 2px; font-size: 11px;
            cursor: pointer; text-align: center; font-family: monospace;
        }
        .triplet-btn.active { background: #004488; border-color: #4488ff; color: white; }

        #zerodiv-scroll { flex: 1; overflow-y: auto; padding: 10px; }
        #zerodiv-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 8px; 
        }
        .zerodiv-btn {
            background: #2a1515; color: #ffcccc; border: 1px solid #442222;
            border-radius: 4px; padding: 5px 2px; min-height: 45px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; text-align: center; font-family: 'Times New Roman', serif;
            font-size: 15px; line-height: 1.2;
        }
        .zerodiv-btn:hover { background: #552222; border-color: #ff4444; }
        .zerodiv-btn sub { font-size: 0.7em; vertical-align: baseline; position: relative; top: 0.3em; margin-left: 1px; }

        /* --- TABLE STYLES --- */
        #table-scroll { flex: 1; overflow: auto; padding: 0; background: #fff; position:relative; }
        #sedenion-table {
            border-collapse: separate; border-spacing: 0;
            font-family: 'Times New Roman', serif; font-size: 11px; table-layout: fixed;
        }
        #sedenion-table td, #sedenion-table th {
            border: 1px solid #ccc; text-align: center;
            white-space: nowrap; overflow: hidden; 
            height: 20px; min-width: 28px; width: 28px; padding: 2px 0;
            cursor: pointer; transition: box-shadow 0.1s;
        }
        #sedenion-table th { background-color: #333; color: white; position: sticky; top: 0; z-index: 100; }
        #sedenion-table .first-col {
            background-color: #333; color: white; position: sticky; left: 0; z-index: 101; font-weight: bold;
            border-right: 1px solid #555; width: 32px; min-width: 32px;
        }
        /* FIX: position relative fondamentale per l'highlight */
        .table-highlight { position: relative; } 
        .table-highlight::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.4); pointer-events: none;
        }
        .table-intersect {
            border: 2px solid black !important; font-weight: bold; transform: scale(1.1); z-index: 50;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .header-active { background-color: #0088ff !important; color: white !important; }
        #table-hint {
            padding: 8px; background: #202025; color: #888; font-size: 11px; 
            border-top: 1px solid #444; text-align: center; font-style: italic;
        }

        /* --- CALCULATOR --- */
        #calc-modal {
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 400px; max-width: 95vw; height: 670px; max-height: 95vh;
            background: #202025; border: 1px solid #555; border-radius: 8px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.9); z-index: 2000;
            flex-direction: column; font-family: 'Segoe UI', sans-serif; overflow: hidden;
        }
        #calc-modal.active { display: flex; }

        .calc-header { 
            padding: 10px 15px; background: #2a2a30; border-bottom: 1px solid #444;
            display: flex; justify-content: space-between; align-items: center; color: white; 
            height: 50px; box-sizing: border-box; flex-shrink: 0;
        }
        .calc-mode-wrapper { display: flex; align-items: center; gap: 10px; flex: 1; }
        .calc-mode-sel { 
            background: #0066cc; color: white; border: 1px solid #0088ff; 
            padding: 5px 10px; font-size: 13px; font-weight: bold;
            border-radius: 4px; cursor: pointer; outline: none;
            transition: background 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .header-actions { display: flex; gap: 15px; align-items: center; }
        .icon-btn { cursor: pointer; font-size: 18px; color: #aaa; transition: 0.2s; user-select: none;}
        .icon-btn:hover { color: white; transform: scale(1.1); }
        .icon-btn.active { color: #00aaff; text-shadow: 0 0 5px #00aaff; }

        .calc-body { 
            flex: 1; padding: 12px; overflow: hidden; color: #ddd; 
            display: flex; flex-direction: column; position: relative;
        }
        .display-area {
            background: #111; border: 1px solid #444; border-radius: 6px;
            padding: 8px 10px; margin-bottom: 8px; display: flex; flex-direction: column; gap: 2px;
            flex-shrink: 0;
        }
        #expression-display {
            width: 100%; background: transparent; border: none; color: #888;
            font-family: monospace; font-size: 13px; outline: none; text-align: right;
        }
        #result-display {
            width: 100%; background: transparent; border: none; color: #0f0;
            font-family: monospace; font-size: 15px; font-weight: bold;
            text-align: right; min-height: 20px; white-space: normal; word-break: break-all; line-height: 1.2;
        }
        .var-tabs { display: flex; gap: 2px; margin-bottom: 5px; border-bottom: 1px solid #444; padding-bottom: 0; flex-shrink: 0; }
        .var-tab {
            flex: 1; background: #2a2a2a; border: 1px solid #444; border-bottom: none; color: #888;
            padding: 6px 2px; text-align: center; cursor: pointer; border-radius: 4px 4px 0 0;
            font-size: 11px; font-weight: bold; transition: 0.2s;
        }
        .var-tab:hover { background: #333; }
        .var-tab.active { background: #333; color: white; border-top: 2px solid #0088ff; }
        .vector-inputs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; margin-bottom: 8px; }
        .input-group { 
            display: flex; align-items: center; background: #151515; 
            border: 1px solid #333; padding: 1px 2px; border-radius: 3px; 
        }
        .input-group.hidden { display: none; }
        .num-input { 
            width: 100%; background: transparent; border: none; color: white; 
            text-align: right; font-family: monospace; outline: none; font-size: 11px; 
        }
        .keypad { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; margin-top: auto; flex-shrink: 0; }
        .key-btn {
            background: #333; color: white; border: 1px solid #444; padding: 8px 0;
            border-radius: 4px; font-weight: bold; cursor: pointer; user-select: none;
            font-family: monospace; font-size: 13px; text-align: center; transition: background 0.1s;
        }
        .key-btn:hover { background: #3a3a3a; }
        .key-btn:active { transform: scale(0.95); background: #555; }
        .key-var { background: #003366; border-color: #004488; }
        .key-num { background: #1a1a1a; border-color: #333; color: #eee; }
        .key-op { background: #2a2a2a; }
        .key-eval { background: #008855; border-color: #00aa66; }
        .key-del { background: #662222; }

        #history-overlay {
            position: absolute; top: 50px; left: 0; right: 0; bottom: 0;
            background: rgba(20, 20, 25, 0.98); z-index: 100;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column; border-left: 1px solid #444;
        }
        #history-overlay.open { transform: translateX(0); }
        .history-header {
            padding: 10px; border-bottom: 1px solid #444; background: #25252a;
            display: flex; justify-content: space-between; align-items: center; font-size: 13px;
        }
        #calc-log { flex: 1; overflow-y: auto; padding: 10px; }
        .log-entry { 
            background: #1a1a1a; border: 1px solid #333; border-radius: 4px; 
            padding: 8px; margin-bottom: 8px; cursor: pointer; transition: 0.2s;
        }
        .log-entry:hover { border-color: #0088ff; background: #222; }
        .log-expr { color: #888; font-size: 11px; margin-bottom: 3px; }
        .log-res { color: #0f8; font-family: monospace; font-size: 12px; word-break: break-all; }

        /* --- 3D LABELS --- */
        .label {
            color: #fff; font-family: 'Times New Roman', serif; font-weight: bold;
            font-style: italic; font-size: 14px; text-shadow: 0 0 3px black;
            pointer-events: none; user-select: none;
        }

        /* --- HELP MODAL --- */
        #help-modal {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 3000;
            justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        #help-modal.visible { display: flex; }
        .help-container {
            width: 500px; max-width: 90%; height: 400px;
            background: #25252b; border: 1px solid #555; border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            display: flex; flex-direction: column; overflow: hidden;
            position: relative;
        }
        .help-header {
            padding: 15px; border-bottom: 1px solid #444; background: #2a2a30;
            display: flex; justify-content: space-between; align-items: center; color: white;
        }
        .help-content { flex: 1; padding: 20px; color: #ddd; font-size: 14px; line-height: 1.6; overflow-y: auto; }
        .help-page { display: none; animation: fadeIn 0.3s; }
        .help-page.active { display: block; }
        .help-footer {
            padding: 10px 15px; border-top: 1px solid #444; background: #2a2a30;
            display: flex; justify-content: space-between; align-items: center;
        }
        .help-nav-btn {
            background: #444; color: white; border: none; padding: 8px 15px;
            border-radius: 6px; cursor: pointer; font-weight: bold;
        }
        .help-nav-btn:hover { background: #666; }
        .help-nav-btn:disabled { opacity: 0.3; cursor: default; }
        .help-indicators { display: flex; gap: 5px; }
        .help-dot { width: 8px; height: 8px; border-radius: 50%; background: #444; }
        .help-dot.active { background: #0088ff; }

        .help-icon-inline {
            display: inline-flex; align-items: center; justify-content: center;
            width: 20px; height: 20px; background: rgba(255,255,255,0.1); border: 1px solid #555;
            border-radius: 4px; font-size: 12px; vertical-align: middle; margin: 0 2px;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="help-modal">
        <div class="help-container">
            <div class="help-header">
                <strong>Guida all'uso</strong>
                <div id="close-help-btn" class="icon-btn" style="font-size:20px;">&times;</div>
            </div>
            <div class="help-content">
                
                <div class="help-page active" data-page="0">
                    <h3 style="color:#00aaff; margin-top:0;">1. Navigazione 3D</h3>
                    <p>Benvenuto nel visualizzatore algebrico interattivo.</p>
                    <ul style="padding-left:20px;">
                        <li><strong>Ruota:</strong> Tieni premuto il <em>Tasto Sinistro</em> del mouse e muovi.</li>
                        <li><strong>Zoom:</strong> Usa la rotellina del mouse.</li>
                        <li><strong>Sposta:</strong> Tieni premuto il <em>Tasto Destro</em> per traslare la vista.</li>
                    </ul>
                    <p>Se ti perdi, apri le impostazioni <span class="help-icon-inline">‚öôÔ∏è</span> e premi <strong>Reset üè†</strong> per tornare alla visuale iniziale.</p>
                </div>

                <div class="help-page" data-page="1">
                    <h3 style="color:#00aaff; margin-top:0;">2. Impostazioni & Algebre</h3>
                    <p>Usa il menu <span class="help-icon-inline">‚öôÔ∏è</span> per:</p>
                    <ul style="padding-left:20px;">
                        <li>Cambiare <strong>Tema</strong> (Spazio, Studio, Nero).</li>
                        <li>Regolare la <strong>Velocit√†</strong> delle animazioni.</li>
                        <li>Mettere in <strong>Pausa</strong> il flusso.</li>
                    </ul>
                    <hr style="border-color:#444;">
                    <p><strong>Filtro Dimensionale:</strong></p>
                    <p>Clicca sul tasto con la lettera gotica in alto a destra (<span class="help-icon-inline">&#x1D54A;</span>) per ciclare tra:</p>
                    <div style="display:flex; gap:10px; margin-top:5px;">
                        <span style="background:#222; padding:2px 6px; border-radius:4px; font-size:12px; border:1px solid #444;">H: Quaternioni (4D)</span>
                        <span style="background:#222; padding:2px 6px; border-radius:4px; font-size:12px; border:1px solid #444;">O: Ottetti (8D)</span>
                        <span style="background:#222; padding:2px 6px; border-radius:4px; font-size:12px; border:1px solid #444;">S: Sedenioni (16D)</span>
                    </div>
                </div>

                <div class="help-page" data-page="2">
                    <h3 style="color:#00aaff; margin-top:0;">3. Calcolatrice Vettoriale</h3>
                    <p>Accedi col tasto <span class="help-icon-inline"><svg style="width:12px;height:12px;fill:white;vertical-align:middle" viewBox="0 0 24 24"><path d="M7,2H17A2,2 0 0,1 19,4V20A2,2 0 0,1 17,22H7A2,2 0 0,1 5,20V4A2,2 0 0,1 7,2M7,4V8H17V4H7M7,10V12H9V10H7M11,10V12H13V10H11M15,10V12H17V10H15M7,14V16H9V14H7M11,14V16H13V14H11M15,14V16H17V14H15M7,18V20H9V18H7M11,18V20H13V18H11M15,18V20H17V18H15Z"/></svg></span>. Esegui operazioni complesse sui 16 elementi.</p>
                    <ul style="padding-left:20px;">
                        <li><strong>Variabili (A-E):</strong> Seleziona una tab (es. "Var A"), inserisci i valori nel vettore e usa <code>a</code> nelle formule.</li>
                        <li><strong>Operazioni:</strong> Somma (+), Prodotto (*), Inverso (/), Coniugato (cnj), Norma (norm).</li>
                        <li><strong>Commutatore:</strong> Usa <code>[x,y]</code> per calcolare il commutatore o <code>[x,y,z]</code> per l'associatore.</li>
                        <li><strong>Cronologia:</strong> Clicca sull'orologio üïí per vedere i calcoli passati e riutilizzare i risultati (Ans).</li>
                    </ul>
                </div>

                <div class="help-page" data-page="3">
                    <h3 style="color:#00aaff; margin-top:0;">4. Tabelle & Divisori</h3>
                    <p>Apri la barra laterale col tasto <span class="help-icon-inline">‚ñ¶</span>.</p>
                    <ul style="padding-left:20px;">
                        <li><strong>Cicli (Triplets):</strong> Elenco delle terne che si comportano come quaternioni (i*j=k). Clicca per illuminarle nel grafico 3D.</li>
                        <li><strong>Divisori Zero:</strong> Coppie di numeri non nulli il cui prodotto √® zero (esclusivo dei Sedenioni). Cliccandoli li carica nella calcolatrice per verificarlo.</li>
                        <li><strong>Tabella:</strong> La tavola di moltiplicazione completa. Clicca su righe/colonne per evidenziare le relazioni.</li>
                    </ul>
                </div>

            </div>
            <div class="help-footer">
                <button id="help-prev-btn" class="help-nav-btn" disabled>&lt; Indietro</button>
                <div class="help-indicators">
                    <div class="help-dot active"></div>
                    <div class="help-dot"></div>
                    <div class="help-dot"></div>
                    <div class="help-dot"></div>
                </div>
                <button id="help-next-btn" class="help-nav-btn">Avanti &gt;</button>
            </div>
        </div>
    </div>

    <div id="calc-modal">
        <div class="calc-header">
            <div class="calc-mode-wrapper">
                <select id="calc-alg-select" class="calc-mode-sel" title="Seleziona Algebra">
                    <option value="3">Quaternioni (H)</option>
                    <option value="7">Ottetti (O)</option>
                    <option value="15" selected>Sedenioni (S)</option>
                </select>
            </div>
            
            <div class="header-actions">
                <div id="toggle-history-btn" class="icon-btn" title="Cronologia">üïí</div>
                <div id="close-calc" class="icon-btn" title="Chiudi" style="font-size: 22px;">&times;</div>
            </div>
        </div>
        
        <div id="history-overlay">
            <div class="history-header">
                <strong>Cronologia Risultati</strong>
                <span id="btn-clear-log" style="cursor:pointer; color:#ff5555;">üóëÔ∏è Pulisci</span>
            </div>
            <div id="calc-log">
                <div style="text-align:center; color:#555; margin-top:20px; font-size:12px;">Nessun calcolo recente</div>
            </div>
        </div>
    
        <div class="calc-body">
            <div class="display-area">
                <input type="text" id="expression-display" placeholder="Espressione..." readonly>
                <div id="result-display">0</div>
            </div>
    
            <div class="var-tabs">
                <div class="var-tab active" data-var="a">Var A</div>
                <div class="var-tab" data-var="b">Var B</div>
                <div class="var-tab" data-var="c">Var C</div>
                <div class="var-tab" data-var="d">Var D</div>
                <div class="var-tab" data-var="e">Var E</div>
            </div>
    
            <div style="margin-bottom: 5px;">
                <div id="input-grid" class="vector-inputs"></div>
            </div>
            
            <div style="display:flex; justify-content:space-between; gap:5px; margin-bottom:8px; flex-shrink:0;">
                 <button class="setting-action" id="btn-grid-clear" style="padding:4px;">Azzera Var</button>
                 <button class="setting-action" id="btn-grid-rand" style="padding:4px;">Random Var</button>
            </div>
    
            <div class="keypad">
                <button class="key-btn key-var" onclick="calcInput('a')">a</button>
                <button class="key-btn key-var" onclick="calcInput('b')">b</button>
                <button class="key-btn key-var" onclick="calcInput('c')">c</button>
                <button class="key-btn key-var" onclick="calcInput('d')">d</button>
                <button class="key-btn key-var" onclick="calcInput('e')">e</button>
                
                <button class="key-btn" onclick="calcInput('norm(')">|v|</button>
                <button class="key-btn" onclick="calcInput('inv(')">inv</button>
                <button class="key-btn" onclick="calcInput('conj(')">cnj</button>
                <button class="key-btn" onclick="calcInput('(')">(</button>
                <button class="key-btn" onclick="calcInput(')')">)</button>
    
                <button class="key-btn key-num" onclick="calcInput('7')">7</button>
                <button class="key-btn key-num" onclick="calcInput('8')">8</button>
                <button class="key-btn key-num" onclick="calcInput('9')">9</button>
                <button class="key-btn key-op" onclick="calcInput(' / ')" title="Moltiplicazione Inverso Destro">/</button>
                <button class="key-btn key-del" onclick="calcAction('back')">‚å´</button>
    
                <button class="key-btn key-num" onclick="calcInput('4')">4</button>
                <button class="key-btn key-num" onclick="calcInput('5')">5</button>
                <button class="key-btn key-num" onclick="calcInput('6')">6</button>
                <button class="key-btn key-op" onclick="calcInput(' * ')">&times;</button>
                <button class="key-btn key-del" onclick="calcAction('clear')">AC</button>
    
                <button class="key-btn key-num" onclick="calcInput('1')">1</button>
                <button class="key-btn key-num" onclick="calcInput('2')">2</button>
                <button class="key-btn key-num" onclick="calcInput('3')">3</button>
                <button class="key-btn key-op" onclick="calcInput(' - ')">-</button>
                <button class="key-btn key-op" onclick="calcInput('comm(')" title="Commutatore [a,b] o Associatore [a,b,c]" style="font-size:11px;">[x,y]</button>
    
                <button class="key-btn key-num" onclick="calcInput('0')">0</button>
                <button class="key-btn key-num" onclick="calcInput('.')">.</button>
                <button class="key-btn key-num" onclick="calcInput(',')" title="Separatore argomenti" style="font-weight:bold; font-size:16px;">,</button>
                <button class="key-btn key-op" onclick="calcInput(' + ')">+</button>
                <button class="key-btn key-eval" onclick="calcAction('eval')">=</button>
            </div>
        </div>
    </div>

    <div id="main-container">
        <div id="canvas-container">
            <div id="top-bar">
                <div class="bar-group">
                    <div id="settings-toggle-btn" class="ui-btn" title="Impostazioni">‚öôÔ∏è</div>
                    <div id="settings-menu">
                        <div class="setting-row"><span>Velocit√†</span><input type="range" id="speed-slider" min="0" max="2" step="0.1" value="0.3" style="width:80px; accent-color:#0f8;"></div>
                        <div class="setting-row"><span>Tema</span><button id="theme-btn" class="setting-action">Cambia üé®</button></div>
                        <div class="setting-row"><span>Camera</span><button id="home-btn" class="setting-action">Reset üè†</button></div>
                        <div class="setting-row"><span>Animazione</span><button id="play-pause-btn" class="setting-action">Pausa ‚ùö‚ùö</button></div>
                        <div class="setting-row"><span>Supporto</span><button id="help-btn-trigger" class="setting-action">?</button></div>
                    </div>
                </div>
                <h2 id="main-title">Sedenioni</h2>
                <div class="bar-group">
                    <div id="btn-alg-toggle" class="ui-btn" style="font-family:'Times New Roman'; font-weight:bold; font-size:22px; color:white;">&#x1D54A;</div>
                    <div id="calc-toggle-btn" class="ui-btn" title="Calcolatrice"><svg class="icon-svg" viewBox="0 0 24 24"><path d="M7,2H17A2,2 0 0,1 19,4V20A2,2 0 0,1 17,22H7A2,2 0 0,1 5,20V4A2,2 0 0,1 7,2M7,4V8H17V4H7M7,10V12H9V10H7M11,10V12H13V10H11M15,10V12H17V10H15M7,14V16H9V14H7M11,14V16H13V14H11M15,14V16H17V14H15M7,18V20H9V18H7M11,18V20H13V18H11M15,18V20H17V18H15Z" /></svg></div>
                    <div id="sidebar-toggle-btn" class="ui-btn" title="Menu Tabelle">‚ñ¶</div>
                </div>
            </div>
        </div>
        <div id="sidebar">
            <div class="sidebar-tabs">
                <button class="tab-btn active" data-tab="triplets" id="tab-btn-triplets">Cicli (35)</button>
                <button class="tab-btn" data-tab="zerodiv" id="tab-btn-zerodiv">Divisori dello zero (84)</button>
                <button class="tab-btn" data-tab="table">Tabella</button>
                <button id="close-sidebar-btn" title="Chiudi">&times;</button>
            </div>
            <div id="tab-triplets" class="tab-content active">
                <div style="padding:10px; border-bottom:1px solid #444; text-align:right;"><button id="show-all-btn" style="background:#008855; border:none; color:white; padding:5px 10px; border-radius:4px; cursor:pointer;">Mostra Tutto</button></div>
                <div id="triplets-scroll"><div class="triplets-grid" id="buttons-container"></div></div>
            </div>
            <div id="tab-zerodiv" class="tab-content"><div id="zerodiv-scroll"><div id="zerodiv-grid"></div></div></div>
            <div id="tab-table" class="tab-content"><div id="table-scroll"><table id="sedenion-table"></table></div><div id="table-hint">Convenzione: Scegliere valore Colonna (Sx) &times; valore Riga (Alto).</div></div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';

        // --- DATI ---
        const POSITIVE_TRIPLETS = [
            [1, 2, 3], [1, 4, 5], [1, 7, 6], [1, 8, 9], [1, 11, 10], [1, 13, 12], [1, 14, 15],
            [2, 4, 6], [2, 5, 7], [2, 8, 10], [2, 9, 11], [2, 14, 12], [2, 15, 13], 
            [3, 4, 7], [3, 6, 5], [3, 8, 11], [3, 10, 9], [3, 13, 14], [3, 15, 12], 
            [4, 8, 12], [4, 9, 13], [4, 10, 14], [4, 11, 15], 
            [5, 8, 13], [5, 10, 15], [5, 12, 9], [5, 14, 11], 
            [6, 8, 14], [6, 11, 13], [6, 12, 10], [6, 15, 9], 
            [7, 8, 15], [7, 9, 14], [7, 12, 11], [7, 13, 10]
        ];
        
        const ZERO_DIVISORS_RAW = [
            [1,10,5,14], [1,10,4,-15], [1,10,7,12], [1,10,6,-13], [1,11,4,14], [1,11,6,-12], [1,11,5,15], [1,11,7,-13],
            [1,12,2,15], [1,12,3,-14], [1,12,6,11], [1,12,7,-10], [1,13,6,10], [1,13,2,-14], [1,13,7,11], [1,13,3,-15],
            [1,14,2,13], [1,14,4,-11], [1,14,3,12], [1,14,5,-10], [1,15,3,13], [1,15,2,-12], [1,15,4,10], [1,15,5,-11],
            [2,9,4,15],  [2,9,5,-14],  [2,9,6,13],  [2,9,7,-12], [2,11,5,12], [2,11,4,-13], [2,11,6,15], [2,11,7,-14],
            [2,12,3,13], [2,12,5,-11], [2,12,7,9],  [2,13,3,-12], [2,13,4,11], [2,13,6,-9],  [2,14,5,9],  [2,14,3,-15],
            [2,14,7,11], [2,15,4,-9],  [2,15,3,14], [2,15,6,-11], [3,9,6,12],  [3,9,4,-14],  [3,9,7,13],  [3,9,5,-15],
            [3,10,4,13], [3,10,5,-12], [3,10,7,14], [3,10,6,-15], [3,12,5,10], [3,12,6,-9],  [3,14,4,9],  [3,13,4,-10],
            [3,15,5,9],  [3,13,7,-9],  [3,15,6,10], [3,14,7,-10], [4,9,7,10],  [4,9,6,-11],  [4,10,5,11], [4,10,7,-9],
            [4,11,6,9],  [4,11,5,-10], [4,13,6,15], [4,13,7,-14], [4,14,7,13], [4,14,5,-15], [4,15,5,14], [4,15,6,-13],
            [5,10,6,9],  [5,9,6,-10],  [5,11,7,9],  [5,9,7,-11], [5,12,7,14], [5,12,6,-15], [5,15,6,12], [5,14,7,-12],
            [6,11,7,10], [6,10,7,-11], [6,13,7,12], [6,12,7,-13]
        ];

        const tableColors = {
            'black': {bg:'rgb(20,20,20)',fg:'white'}, 'marrone': {bg:'rgb(153,102,0)',fg:'black'}, 'rosso': {bg:'rgb(255,0,0)',fg:'black'},
            'arancione': {bg:'rgb(255,102,0)',fg:'black'}, 'ocra': {bg:'rgb(255,215,0)',fg:'black'}, 'giallo': {bg:'rgb(255,255,0)',fg:'black'},
            'verdechiaro': {bg:'rgb(0,255,0)',fg:'black'}, 'verde': {bg:'rgb(0,153,0)',fg:'black'}, 'verdescuro': {bg:'rgb(0,100,0)',fg:'white'},
            'viola': {bg:'rgb(127,0,255)',fg:'white'}, 'bluscuro': {bg:'rgb(0,0,204)',fg:'white'}, 'bluet': {bg:'rgb(51,51,255)',fg:'white'},
            'azzurro': {bg:'rgb(102,204,255)',fg:'black'}, 'violetto': {bg:'rgb(255,0,255)',fg:'black'}, 'fucsia': {bg:'rgb(255,102,153)',fg:'black'},
            'rosa': {bg:'rgb(255,192,203)',fg:'black'}
        };
        const indexToColorKey = ['black','marrone','rosso','arancione','ocra','giallo','verdechiaro','verde','verdescuro','viola','bluscuro','bluet','azzurro','violetto','fucsia','rosa'];

        const tableRaw = [
            ["1", "e1", "e2", "e3", "e4", "e5", "e6", "e7", "e8", "e9", "e10", "e11", "e12", "e13", "e14", "e15"],
            ["e1", "-1", "e3", "-e2", "e5", "-e4", "-e7", "e6", "e9", "-e8", "-e11", "e10", "-e13", "e12", "e15", "-e14"],
            ["e2", "-e3", "-1", "e1", "e6", "e7", "-e4", "-e5", "e10", "e11", "-e8", "-e9", "-e14", "-e15", "e12", "e13"],
            ["e3", "e2", "-e1", "-1", "e7", "-e6", "e5", "-e4", "e11", "-e10", "e9", "-e8", "-e15", "e14", "-e13", "e12"],
            ["e4", "-e5", "-e6", "-e7", "-1", "e1", "e2", "e3", "e12", "e13", "e14", "e15", "-e8", "-e9", "-e10", "-e11"],
            ["e5", "e4", "-e7", "e6", "-e1", "-1", "-e3", "e2", "e13", "-e12", "e15", "-e14", "e9", "-e8", "e11", "-e10"],
            ["e6", "e7", "e4", "-e5", "-e2", "e3", "-1", "-e1", "e14", "-e15", "-e12", "e13", "e10", "-e11", "-e8", "e9"],
            ["e7", "-e6", "e5", "e4", "-e3", "-e2", "e1", "-1", "e15", "e14", "-e13", "-e12", "e11", "e10", "-e9", "-e8"],
            ["e8", "-e9", "-e10", "-e11", "-e12", "-e13", "-e14", "-e15", "-1", "e1", "e2", "e3", "e4", "e5", "e6", "e7"],
            ["e9", "e8", "-e11", "e10", "-e13", "e12", "e15", "-e14", "-e1", "-1", "-e3", "e2", "-e5", "e4", "e7", "-e6"],
            ["e10", "e11", "e8", "-e9", "-e14", "-e15", "e12", "e13", "-e2", "e3", "-1", "-e1", "-e6", "-e7", "e4", "e5"],
            ["e11", "-e10", "e9", "e8", "-e15", "e14", "-e13", "e12", "-e3", "-e2", "e1", "-1", "-e7", "e6", "-e5", "e4"],
            ["e12", "e13", "e14", "e15", "e8", "-e9", "-e10", "-e11", "-e4", "e5", "e6", "e7", "-1", "-e1", "-e2", "-e3"],
            ["e13", "-e12", "e15", "-e14", "e9", "e8", "e11", "-e10", "-e5", "-e4", "e7", "-e6", "e1", "-1", "e3", "-e2"],
            ["e14", "-e15", "-e12", "e13", "e10", "-e11", "e8", "e9", "-e6", "-e7", "-e4", "e5", "e2", "-e3", "-1", "e1"],
            ["e15", "e14", "-e13", "-e12", "e11", "e10", "-e9", "e8", "-e7", "e6", "-e5", "-e4", "e3", "e2", "-e1", "-1"]
        ];

        const palette = [0xff3333, 0xffaa00, 0xffff00, 0x00ff00, 0x00ffff, 0x0066ff, 0xaa00ff, 0xff00ff];

        // --- FUNZIONI TABELLA ---
        let tableState = { activeRow: null, activeCol: null };

        function getBaseIndex(valStr) {
            let s = valStr.replace('-', '');
            if (s === '1') return 0;
            return parseInt(s.substring(1));
        }

        function formatLatex(str) {
            if (str === '1' || str === '-1') return str;
            return str.replace(/e(\d+)/, 'e<sub>$1</sub>');
        }

        function activateTripletFromTable(r, c) {
            if(r === 0 || c === 0 || r === c) return;
            const tripletIdx = POSITIVE_TRIPLETS.findIndex(t => t.includes(r) && t.includes(c));
            if (tripletIdx !== -1) {
                const limit = parseInt(document.getElementById('calc-alg-select').value) || 15;
                const triplet = POSITIVE_TRIPLETS[tripletIdx];
                if(triplet.some(v => v > limit)) return;
                visualizeTripletByIndex(tripletIdx);
            }
        }

        function buildTable(limitIndex) {
            const table = document.getElementById('sedenion-table');
            table.innerHTML = ''; 
            const thead = document.createElement('tr');
            const corner = document.createElement('th');
            corner.innerHTML = "&times;"; 
            corner.classList.add("first-col");
            corner.onclick = () => { tableState.activeRow=null; tableState.activeCol=null; buildTable(limitIndex); };
            thead.appendChild(corner);
            
            for(let i=0; i<=limitIndex; i++) {
                const th = document.createElement('th');
                th.innerHTML = i === 0 ? "1" : "e<sub>" + i + "</sub>";
                if(i === tableState.activeCol) th.classList.add('header-active');
                th.onclick = () => { tableState.activeCol = (tableState.activeCol === i) ? null : i; buildTable(limitIndex); };
                thead.appendChild(th);
            }
            table.appendChild(thead);

            for(let r=0; r<=limitIndex; r++) {
                const tr = document.createElement('tr');
                const thRow = document.createElement('td');
                thRow.innerHTML = r === 0 ? "1" : "e<sub>" + r + "</sub>";
                thRow.classList.add("first-col");
                if(r === tableState.activeRow) thRow.classList.add('header-active');
                thRow.onclick = () => { tableState.activeRow = (tableState.activeRow === r) ? null : r; buildTable(limitIndex); };
                tr.appendChild(thRow);

                for(let c=0; c<=limitIndex; c++) {
                    const td = document.createElement('td');
                    const val = tableRaw[r][c];
                    const style = tableColors[indexToColorKey[getBaseIndex(val)]];
                    td.innerHTML = formatLatex(val);
                    td.style.backgroundColor = style.bg;
                    td.style.color = style.fg;

                    let isDimmed = false;
                    if (tableState.activeRow !== null || tableState.activeCol !== null) {
                        const rowMatch = (tableState.activeRow === r);
                        const colMatch = (tableState.activeCol === c);
                        if (rowMatch && colMatch) td.classList.add('table-intersect');
                        else if (!rowMatch && !colMatch) td.classList.add('table-highlight');
                    }
                    td.onclick = () => activateTripletFromTable(r, c);
                    tr.appendChild(td);
                }
                table.appendChild(tr);
            }
        }

        // --- 3D SCENE ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a1a);
        const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
        const initialCameraPos = new THREE.Vector3(14, 12, 24);
        camera.position.copy(initialCameraPos);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);
        const labelRenderer = new CSS2DRenderer();
        labelRenderer.setSize(container.clientWidth, container.clientHeight);
        labelRenderer.domElement.style.position = 'absolute';
        labelRenderer.domElement.style.top = '0px';
        labelRenderer.domElement.style.pointerEvents = 'none';
        container.appendChild(labelRenderer.domElement);
        
        // --- FIX ZOOM LIMITS ---
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; controls.dampingFactor = 0.05;
        controls.minDistance = 2; // Evita di entrare nelle sfere
        controls.maxDistance = 150; // Evita di perdere il grafico nel vuoto

        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(10, 20, 10);
        scene.add(dirLight);

        // --- GEOMETRIA ---
        const S = 12.0; 
        const h_tri = S * Math.sqrt(3) / 2;       
        const r_center = h_tri / 3;               
        const R_vertex = h_tri * 2 / 3;           
        const H_pyr = S * Math.sqrt(2 / 3);       
        const v_e5 = new THREE.Vector3(-S/2, 0, r_center);   
        const v_e6 = new THREE.Vector3( S/2, 0, r_center);    
        const v_e7 = new THREE.Vector3(0, 0, -R_vertex);   
        const v_e12 = new THREE.Vector3(0, H_pyr, 0);   
        const mid = (v1, v2) => new THREE.Vector3().addVectors(v1, v2).multiplyScalar(0.5);
        const centroid3 = (v1, v2, v3) => new THREE.Vector3().addVectors(v1, v2).add(v3).divideScalar(3);
        const pts = {};
        pts[5] = v_e5; pts[6] = v_e6; pts[7] = v_e7; pts[12] = v_e12; 
        pts[3] = mid(v_e5, v_e6); pts[2] = mid(v_e5, v_e7); pts[1] = mid(v_e6, v_e7);
        pts[4] = centroid3(v_e5, v_e6, v_e7);
        pts[9] = mid(v_e5, v_e12); pts[10] = mid(v_e6, v_e12); pts[15] = centroid3(v_e5, v_e6, v_e12);
        pts[11] = mid(v_e7, v_e12); pts[14] = centroid3(v_e12, v_e5, v_e7);
        pts[13] = centroid3(v_e6, v_e7, v_e12);
        pts[8] = new THREE.Vector3().addVectors(v_e5, v_e6).add(v_e7).add(v_e12).multiplyScalar(0.25);

        const pointObjects = {}; 
        const sphereGeom = new THREE.SphereGeometry(0.22, 16, 16);
        const sphereMat = new THREE.MeshPhysicalMaterial({ color: 0xaaaaaa, metalness: 0.2, roughness: 0.4 });
        const sphereMatCenter = new THREE.MeshPhysicalMaterial({ color: 0xffdd00, metalness: 0.2, roughness: 0.4 });

        Object.keys(pts).forEach(k => {
            const idx = parseInt(k);
            const mesh = new THREE.Mesh(sphereGeom, idx===8 ? sphereMatCenter : sphereMat);
            mesh.position.copy(pts[k]);
            scene.add(mesh);
            const div = document.createElement('div');
            div.className = 'label';
            div.innerHTML = 'e<sub>' + idx + '</sub>';
            const label = new CSS2DObject(div);
            label.position.set(0, 0.4, 0);
            mesh.add(label);
            pointObjects[idx] = { mesh, label };
        });

        // --- SHADER PATHS ---
        const flowVertexShader = `
            varying vec2 vUv;
            void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }
        `;
        const flowFragmentShader = `
            uniform vec3 color; uniform float customTime; uniform float flowDir; varying vec2 vUv;
            void main() {
                float t = customTime; float uvX = (flowDir > 0.0) ? vUv.x : (1.0 - vUv.x);
                float progress = fract(uvX - t); float head = smoothstep(0.8, 1.0, progress); 
                float tail = pow(progress, 3.0); vec3 finalRGB = mix(color * 0.1, color, tail);
                finalRGB = mix(finalRGB, vec3(1.0), head); gl_FragColor = vec4(finalRGB, 1.0);
            }
        `;
        const animatedMaterials = [];
        const tripletVisuals = [];
        const animParams = { speed: 0.3, paused: false, customTime: 0 };

        function createTripletPath(triplet, colorHex) {
            const [i1, i2, i3] = triplet;
            const p1 = pts[i1], p2 = pts[i2], p3 = pts[i3];
            let points = [];
            let isOpenCurve = false; 
            const v12 = new THREE.Vector3().subVectors(p2, p1);
            const v13 = new THREE.Vector3().subVectors(p3, p1);
            const normal = new THREE.Vector3().crossVectors(v12, v13);
            const isCollinear = normal.lengthSq() < 0.001;

            if (isCollinear) {
                isOpenCurve = true; 
                const d12 = p1.distanceTo(p2); const d23 = p2.distanceTo(p3); const d31 = p3.distanceTo(p1);
                if (d12 >= d23 && d12 >= d31) points.push(p1, p3, p2);
                else if (d23 >= d12 && d23 >= d31) points.push(p2, p1, p3);
                else points.push(p3, p2, p1);
            } else {
                isOpenCurve = false; 
                const axisZ = normal.normalize(); 
                const v1 = new THREE.Vector3().subVectors(p2, p1);
                const v2 = new THREE.Vector3().subVectors(p3, p1);
                const v1xv2 = new THREE.Vector3().crossVectors(v1, v2);
                const lenSq = v1xv2.lengthSq();
                const centerOffset = new THREE.Vector3().addVectors(v2.clone().multiplyScalar(v1.lengthSq()).cross(v1xv2), v1xv2.clone().cross(v1.clone().multiplyScalar(v2.lengthSq()))).divideScalar(2 * lenSq);
                const Center = new THREE.Vector3().addVectors(p1, centerOffset);
                const Radius = centerOffset.length();
                const axisX = new THREE.Vector3().subVectors(p1, Center).normalize();
                const axisY = new THREE.Vector3().crossVectors(axisZ, axisX).normalize();
                for(let i=0; i<=64; i++) {
                    const theta = (i / 64) * Math.PI * 2;
                    points.push(new THREE.Vector3().copy(Center).add(axisX.clone().multiplyScalar(Radius * Math.cos(theta))).add(axisY.clone().multiplyScalar(Radius * Math.sin(theta))));
                }
            }
            const curve = new THREE.CatmullRomCurve3(points, !isOpenCurve, 'catmullrom', isCollinear ? 1.0 : 0.5);
            const tubeGeom = new THREE.TubeGeometry(curve, 256, 0.035, 8, !isOpenCurve);
            const material = new THREE.ShaderMaterial({
                uniforms: { customTime: { value: 0 }, color: { value: new THREE.Color(colorHex) }, flowDir: { value: isCollinear ? -1.0 : 1.0 } },
                vertexShader: flowVertexShader, fragmentShader: flowFragmentShader,
                transparent: true, depthWrite: false, depthTest: true, side: THREE.FrontSide, blending: THREE.AdditiveBlending
            });
            animatedMaterials.push(material);
            const mesh = new THREE.Mesh(tubeGeom, material);
            scene.add(mesh);
            tripletVisuals.push({ ids: triplet, mesh: mesh, color: colorHex });
        }
        POSITIVE_TRIPLETS.forEach((triplet, idx) => createTripletPath(triplet, palette[idx % palette.length]));

        // --- UI LOGIC ---
        const titleElem = document.getElementById('main-title');
        const tripletButtons = [];
        const btnAlgToggle = document.getElementById('btn-alg-toggle');
        let currentAlgState = 15;

        function updateAlgebraState(forcedState) {
            if (forcedState) currentAlgState = forcedState;
            else {
                if (currentAlgState === 3) currentAlgState = 7;
                else if (currentAlgState === 7) currentAlgState = 15;
                else currentAlgState = 3;
            }
            if (currentAlgState === 3) btnAlgToggle.innerHTML = "&#x210D;";
            else if (currentAlgState === 7) btnAlgToggle.innerHTML = "&#x1D546;";
            else btnAlgToggle.innerHTML = "&#x1D54A;";
            filterSubspace(currentAlgState);
        }
        
        filterSubspace(15);
        btnAlgToggle.addEventListener('click', () => updateAlgebraState(null));

        function filterSubspace(limitIndex) {
            if(limitIndex===3) titleElem.innerText = "Quaternioni";
            else if(limitIndex===7) titleElem.innerText = "Ottetti";
            else titleElem.innerText = "Sedenioni";

            // --- INIZIO MODIFICA: Aggiorna etichetta Cicli ---
            let tripletCount = 35; // Default Sedenioni
            if (limitIndex === 3) tripletCount = 1;      // Quaternioni
            if (limitIndex === 7) tripletCount = 7;      // Ottetti
            
            document.getElementById('tab-btn-triplets').innerText = `Cicli (${tripletCount})`;
            // --- FINE MODIFICA ---

            for (let idStr in pointObjects) {
                const id = parseInt(idStr);
                const visible = id <= limitIndex;
                pointObjects[id].mesh.visible = visible;
                pointObjects[id].label.visible = visible;
            }
            tripletVisuals.forEach((t, i) => {
                const isVisible = t.ids.every(val => val <= limitIndex);
                t.mesh.visible = isVisible;
                if(tripletButtons[i]) tripletButtons[i].style.display = isVisible ? 'block' : 'none';
            });
            tableState.activeRow = null; tableState.activeCol = null;
            buildTable(limitIndex);
            
            const zdBtn = document.getElementById('tab-btn-zerodiv');
            if(limitIndex < 15) {
                zdBtn.style.display = 'none';
                if(zdBtn.classList.contains('active')) document.getElementById('tab-btn-triplets').click();
            } else {
                zdBtn.style.display = 'block';
            }
        }

        const settingsToggle = document.getElementById('settings-toggle-btn');
        const settingsMenu = document.getElementById('settings-menu');
        settingsToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            settingsMenu.classList.toggle('visible');
            settingsToggle.classList.toggle('active');
        });
        document.addEventListener('click', (e) => {
            if(!settingsMenu.contains(e.target) && e.target !== settingsToggle) {
                settingsMenu.classList.remove('visible');
                settingsToggle.classList.remove('active');
            }
        });

        document.getElementById('speed-slider').addEventListener('input', (e) => animParams.speed = parseFloat(e.target.value));
        document.getElementById('home-btn').addEventListener('click', () => { camera.position.copy(initialCameraPos); controls.target.set(0,3,0); });
        const playBtn = document.getElementById('play-pause-btn');
        playBtn.addEventListener('click', () => {
            animParams.paused = !animParams.paused;
            playBtn.innerText = animParams.paused ? "Play ‚ñ∂" : "Pausa ‚ùö‚ùö";
        });
        
        let currentTheme = 0;
        const themeBtn = document.getElementById('theme-btn');
        const gridHelper = new THREE.GridHelper(60, 30, 0x444444, 0x111111); gridHelper.visible = false; gridHelper.position.y = -8; scene.add(gridHelper);
        const starsCount = 1000; const starsGeo = new THREE.BufferGeometry(); const starsPos = new Float32Array(starsCount*3);
        for(let i=0; i<starsCount*3; i++) starsPos[i] = (Math.random()-0.5)*100;
        starsGeo.setAttribute('position', new THREE.BufferAttribute(starsPos,3));
        const starField = new THREE.Points(starsGeo, new THREE.PointsMaterial({size:0.15, color:0xffffff})); starField.visible=false; scene.add(starField);

        themeBtn.addEventListener('click', () => {
            currentTheme = (currentTheme + 1) % 5;
            scene.background = null; gridHelper.visible = false; starField.visible = false; container.className = ''; scene.fog = null;
            if(currentTheme === 0) { scene.background = new THREE.Color(0x1a1a1a); }
            else if(currentTheme === 1) { container.classList.add('bg-deep-space'); scene.fog = new THREE.FogExp2(0x101020, 0.015); }
            else if(currentTheme === 2) { container.classList.add('bg-studio'); }
            else if(currentTheme === 3) { scene.background = new THREE.Color(0x181818); gridHelper.visible = true; }
            else if(currentTheme === 4) { scene.background = new THREE.Color(0x0a0a14); starField.visible = true; }
        });

        // Sidebar
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle-btn');
        const sidebarClose = document.getElementById('close-sidebar-btn');
        function toggleSidebar() {
            sidebar.classList.toggle('open');
            sidebarToggle.classList.toggle('active');
            setTimeout(() => {
                const w = container.clientWidth; const h = container.clientHeight;
                camera.aspect = w / h; camera.updateProjectionMatrix(); renderer.setSize(w, h); labelRenderer.setSize(w, h);
            }, 350);
        }
        sidebarToggle.addEventListener('click', toggleSidebar);
        sidebarClose.addEventListener('click', () => { sidebar.classList.remove('open'); sidebarToggle.classList.remove('active'); });

        const tabs = document.querySelectorAll('.tab-btn');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                if(tab.id === 'close-sidebar-btn') return;
                tabs.forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            });
        });

        function visualizeTripletByIndex(idx) {
            document.querySelectorAll('.triplet-btn').forEach(b => b.classList.remove('active'));
            if(tripletButtons[idx]) tripletButtons[idx].classList.add('active');
            const triplet = POSITIVE_TRIPLETS[idx];
            tripletVisuals.forEach((t, i) => t.mesh.visible = (i===idx));
            for(let idStr in pointObjects) {
                const id = parseInt(idStr);
                const obj = pointObjects[id];
                const inTriplet = triplet.includes(id);
                obj.mesh.visible = inTriplet; 
                obj.label.visible = inTriplet;
            }
        }

        const buttonsContainer = document.getElementById('buttons-container');
        POSITIVE_TRIPLETS.forEach((triplet, idx) => {
            const btn = document.createElement('div');
            btn.className = 'triplet-btn';
            btn.innerText = `{${triplet[0]}, ${triplet[1]}, ${triplet[2]}}`;
            const hex = tripletVisuals[idx].color.toString(16).padStart(6,'0');
            btn.style.borderLeft = `4px solid #${hex}`;
            btn.addEventListener('click', () => visualizeTripletByIndex(idx));
            buttonsContainer.appendChild(btn);
            tripletButtons.push(btn);
        });
        document.getElementById('show-all-btn').addEventListener('click', () => {
            document.querySelectorAll('.triplet-btn').forEach(b => b.classList.remove('active'));
            filterSubspace(currentAlgState);
        });

        const zdContainer = document.getElementById('zerodiv-grid');
        ZERO_DIVISORS_RAW.forEach(zd => {
            const btn = document.createElement('div');
            btn.className = 'zerodiv-btn';
            const a = `(e<sub>${zd[0]}</sub>+e<sub>${zd[1]}</sub>)`;
            const sign1 = zd[2] < 0 ? "-" : ""; const sign2 = zd[3] < 0 ? "-" : "+";
            const b = `(${sign1}e<sub>${Math.abs(zd[2])}</sub>${sign2}e<sub>${Math.abs(zd[3])}</sub>)`;
            btn.innerHTML = a + b;
            btn.addEventListener('click', () => {
                openCalculator();
                saveVar(currentVar); switchVar('a'); setGrid(createZeroVector()); 
                const inputs = document.querySelectorAll('#input-grid input');
                inputs[zd[0]].value = 1; inputs[zd[1]].value = 1;
                saveVar('a'); switchVar('b'); setGrid(createZeroVector());
                inputs[Math.abs(zd[2])].value = Math.sign(zd[2]); inputs[Math.abs(zd[3])].value = Math.sign(zd[3]);
                saveVar('b');
                document.getElementById('expression-display').value = 'a * b';
                calcAction('eval');
            });
            zdContainer.appendChild(btn);
        });

        // Help Modal
        const helpModal = document.getElementById('help-modal');
        const helpBtnTrigger = document.getElementById('help-btn-trigger');
        const closeHelpBtn = document.getElementById('close-help-btn');
        const helpNext = document.getElementById('help-next-btn');
        const helpPrev = document.getElementById('help-prev-btn');
        const helpPages = document.querySelectorAll('.help-page');
        const helpDots = document.querySelectorAll('.help-dot');
        let currentHelpPage = 0;

        function updateHelpUI() {
            helpPages.forEach((p, i) => p.classList.toggle('active', i === currentHelpPage));
            helpDots.forEach((d, i) => d.classList.toggle('active', i === currentHelpPage));
            helpPrev.disabled = currentHelpPage === 0;
            helpNext.innerText = currentHelpPage === helpPages.length - 1 ? "Chiudi" : "Avanti >";
        }
        helpBtnTrigger.addEventListener('click', () => {
            helpModal.classList.add('visible');
            settingsMenu.classList.remove('visible'); settingsToggle.classList.remove('active');
            currentHelpPage = 0; updateHelpUI();
        });
        closeHelpBtn.addEventListener('click', () => helpModal.classList.remove('visible'));
        helpNext.addEventListener('click', () => {
            if(currentHelpPage < helpPages.length - 1) { currentHelpPage++; updateHelpUI(); } else { helpModal.classList.remove('visible'); }
        });
        helpPrev.addEventListener('click', () => { if(currentHelpPage > 0) { currentHelpPage--; updateHelpUI(); } });
        helpModal.addEventListener('click', (e) => { if(e.target === helpModal) helpModal.classList.remove('visible'); });


        // =============================================================
        // ===================== ADVANCED CALCULATOR ===================
        // =============================================================

        const calcModal = document.getElementById('calc-modal');
        const calcToggle = document.getElementById('calc-toggle-btn');
        const calcClose = document.getElementById('close-calc');
        const inputGrid = document.getElementById('input-grid');
        const calcAlgSelect = document.getElementById('calc-alg-select');
        
        let storedVars = {
            a: new Array(16).fill(0), b: new Array(16).fill(0), c: new Array(16).fill(0),
            d: new Array(16).fill(0), e: new Array(16).fill(0)
        };
        let storedAns = []; 
        let currentVar = 'a';

        function createZeroVector() { return new Array(16).fill(0); }
        function vecAdd(v1, v2) { return v1.map((x, i) => x + v2[i]); }
        function vecSub(v1, v2) { return v1.map((x, i) => x - v2[i]); }
        function vecScale(v, s) { return v.map(x => x * s); }
        function vecNormSq(v) { return v.reduce((sum, x) => sum + x*x, 0); }
        function vecNorm(v) { const n = Math.sqrt(vecNormSq(v)); const res = createZeroVector(); res[0] = n; return res; }
        function vecConj(v) { return v.map((x, i) => i === 0 ? x : -x); }
        function vecInv(v) {
            const n2 = vecNormSq(v);
            if(n2 < 1e-9) throw "Divisione per zero";
            return vecScale(vecConj(v), 1/n2);
        }
        function vecMul(A, B) {
            const res = createZeroVector();
            for(let i=0; i<16; i++) {
                if(Math.abs(A[i]) < 1e-9) continue;
                for(let j=0; j<16; j++) {
                    if(Math.abs(B[j]) < 1e-9) continue;
                    const cell = tableRaw[i][j];
                    const sign = cell.startsWith('-') ? -1 : 1;
                    const idx = getBaseIndex(cell);
                    res[idx] += A[i] * B[j] * sign;
                }
            }
            return res;
        }

        // Commutator: [a,b] = ab - ba
        function vecComm(a, b) {
            return vecSub(vecMul(a, b), vecMul(b, a));
        }
        // Associator: [a,b,c] = (ab)c - a(bc)
        function vecAssoc(a, b, c) {
            return vecSub(vecMul(vecMul(a, b), c), vecMul(a, vecMul(b, c)));
        }

        const ops = {
            '+': { prec: 2, assoc: 'L', fn: vecAdd },
            '-': { prec: 2, assoc: 'L', fn: vecSub },
            '*': { prec: 3, assoc: 'L', fn: vecMul },
            '/': { prec: 3, assoc: 'L', fn: (a,b) => vecMul(a, vecInv(b)) }, 
            '~': { prec: 4, assoc: 'R', fn: (a) => vecScale(a, -1) }, // UNARY MINUS
            ',': { prec: 1, assoc: 'L', fn: null }, // Separator
            'norm': { type: 'func', fn: vecNorm },
            'conj': { type: 'func', fn: vecConj },
            'inv': { type: 'func', fn: vecInv },
            'comm': { type: 'func_var', fn: null }, // Placeholder for parsing
            'comm2': { type: 'func', fn: vecComm }, // Real function 2 args
            'comm3': { type: 'func', fn: vecAssoc } // Real function 3 args
        };

        function evaluateExpression(exprStr) {
            // Tokenizer that includes comma and handles unary minus logic
            let tokens = exprStr.replace(/\s+/g, '').split(/([+\-*/(),]|norm|conj|inv|comm)/).filter(t => t);
            
            // Unary Minus Detection: if '-' is at start or follows operator/paren, change to '~'
            for(let i=0; i<tokens.length; i++) {
                if(tokens[i] === '-') {
                    const prev = i > 0 ? tokens[i-1] : null;
                    const isUnary = (i === 0) || (['+','-','*','/','(','comm',','].includes(prev));
                    if(isUnary) tokens[i] = '~';
                }
            }

            const outputQueue = [];
            const opStack = [];
            
            // Extended Shunting-Yard
            for(let i=0; i<tokens.length; i++) {
                const token = tokens[i];
                if (storedVars[token] || token.startsWith('Ans') || !isNaN(parseFloat(token))) { 
                    outputQueue.push(token); 
                } else if (ops[token] && (ops[token].type === 'func' || ops[token].type === 'func_var')) {
                    opStack.push(token);
                } else if (token === ',') {
                     // Separator: pop until '('
                    while (opStack.length > 0 && opStack[opStack.length-1] !== '(') {
                        outputQueue.push(opStack.pop());
                    }
                } else if (ops[token]) { 
                    while (opStack.length > 0) {
                        const top = opStack[opStack.length-1];
                        if (top === '(') break;
                        if ((ops[token].assoc === 'L' && ops[token].prec <= ops[top].prec) ||
                            (ops[token].assoc === 'R' && ops[token].prec < ops[top].prec)) {
                            outputQueue.push(opStack.pop());
                        } else { break; }
                    }
                    opStack.push(token);
                } else if (token === '(') {
                    opStack.push(token);
                } else if (token === ')') {
                    let commaCount = 0;
                    // Pop loop to find matching paren
                    while (opStack.length > 0 && opStack[opStack.length-1] !== '(') {
                        outputQueue.push(opStack.pop());
                    }
                    opStack.pop(); // Remove '('

                    // Check if function preceding '('
                    if (opStack.length > 0 && ops[opStack[opStack.length-1]].type === 'func_var') {
                        // We found a variable function (comm).
                        // We need to know how many args. 
                        // Simplified: Count commas inside the parenthesis scope.
                        // Since standard Shunting Yard doesn't track args easily, 
                        // we scan original tokens inside the parens we just closed?
                        // Hack: Count how many arguments were pushed to output queue? No.
                        
                        // Robust method: Count commas in the source string corresponding to this function call? 
                        // Or imply arg count from the output stack logic?
                        // Let's use a simpler heuristic for this calculator:
                        // Count commas in the token stream between the matching parens.
                        
                        // Let's re-scan tokens backward? No.
                        // Let's modify the comma handling. 
                        // When ',' is hit, we verify the function at top-1 of stack (under '(').
                        // Let's attach argCount to the stack object.
                    }
                    
                    // Actually, simpler approach for `comm`:
                    // Just look at the stack. If it's `comm`, we replace it with `comm2` or `comm3`.
                    // But RPN queue is linear.
                    // Let's do this: When evaluating RPN, if we see `comm`, we don't know if it's 2 or 3.
                    // Solution: Convert `comm` to `comm2` or `comm3` DURING tokenization or parsing.
                    
                    // Let's count commas in the current scope.
                    // Finding the scope in `tokens`: find matching `)` for the `(` after `comm`.
                }
            }
            while (opStack.length > 0) outputQueue.push(opStack.pop());

            // FIX: The above logic for `comm` is incomplete. 
            // Better strategy: Use a recursive evaluator or count args explicitly.
            // Since we can't easily rewrite the whole parser, let's fix `comm` handling by pre-processing.
            // Replace `comm(a,b,c)` with `comm3(a,b,c)` and `comm(a,b)` with `comm2(a,b)`.
            // Regex is hard with nested parens.
            
            // Let's do a quick pass to rename `comm`.
            let level = 0;
            let commScopes = []; // { start: index of 'comm', args: 1 }
            
            // Reset tokens for clarity
            tokens = exprStr.replace(/\s+/g, '').split(/([+\-*/(),]|norm|conj|inv|comm)/).filter(t => t);
            // Handle Unary Minus again
            for(let i=0; i<tokens.length; i++) {
                if(tokens[i] === '-') {
                    const prev = i > 0 ? tokens[i-1] : null;
                    const isUnary = (i === 0) || (['+','-','*','/','(','comm',','].includes(prev));
                    if(isUnary) tokens[i] = '~';
                }
            }

            // Identify comm arity
            for(let i=0; i<tokens.length; i++) {
                if(tokens[i] === 'comm') {
                    // Look ahead for (
                    // We need to find corresponding closing paren and count commas at this level.
                    let localLevel = 0;
                    let commCount = 0;
                    for(let j=i+1; j<tokens.length; j++) {
                        if(tokens[j] === '(') localLevel++;
                        else if(tokens[j] === ')') {
                            localLevel--;
                            if(localLevel === 0) break; // End of comm args
                        }
                        else if(tokens[j] === ',' && localLevel === 1) {
                            commCount++;
                        }
                    }
                    if(commCount === 1) tokens[i] = 'comm2';
                    else if(commCount === 2) tokens[i] = 'comm3';
                    else throw "Commutatore accetta solo 2 o 3 argomenti";
                }
            }

            // Re-run shunting yard with renamed tokens
             const finalQueue = [];
             const finalStack = [];
             
             for(let token of tokens) {
                 if (storedVars[token] || token.startsWith('Ans') || !isNaN(parseFloat(token))) { 
                     finalQueue.push(token); 
                 } else if (ops[token] && ops[token].type === 'func') {
                     finalStack.push(token);
                 } else if (token === ',') {
                     while (finalStack.length > 0 && finalStack[finalStack.length-1] !== '(') {
                         finalQueue.push(finalStack.pop());
                     }
                 } else if (ops[token]) { 
                     while (finalStack.length > 0) {
                         const top = finalStack[finalStack.length-1];
                         if (top === '(') break;
                         if ((ops[token].assoc === 'L' && ops[token].prec <= ops[top].prec) ||
                             (ops[token].assoc === 'R' && ops[token].prec < ops[top].prec)) {
                             finalQueue.push(finalStack.pop());
                         } else { break; }
                     }
                     finalStack.push(token);
                 } else if (token === '(') {
                     finalStack.push(token);
                 } else if (token === ')') {
                     while (finalStack.length > 0 && finalStack[finalStack.length-1] !== '(') {
                         finalQueue.push(finalStack.pop());
                     }
                     finalStack.pop(); 
                     if (finalStack.length > 0 && ops[finalStack[finalStack.length-1]].type === 'func') {
                         finalQueue.push(finalStack.pop());
                     }
                 }
             }
             while (finalStack.length > 0) finalQueue.push(finalStack.pop());

            // --- EVALUATION ---
            const evalStack = [];
            const getV = (t) => {
                if(typeof t !== 'string') return t; 
                if(storedVars[t]) {
                    const limit = parseInt(calcAlgSelect.value);
                    return storedVars[t].map((v,i) => i <= limit ? v : 0);
                } 
                if(t.startsWith('Ans')) {
                    const idx = parseInt(t.substring(3)) - 1;
                    return storedAns[idx] || createZeroVector();
                }
                const num = parseFloat(t);
                if(!isNaN(num)) { const v = createZeroVector(); v[0]=num; return v; }
                throw "Simbolo sconosciuto: " + t;
            };

            for(let token of finalQueue) {
                if(ops[token]) {
                    if(token === '~') {
                        const a = getV(evalStack.pop());
                        evalStack.push(ops[token].fn(a));
                    }
                    else if(token === 'comm3') {
                        const c = getV(evalStack.pop());
                        const b = getV(evalStack.pop());
                        const a = getV(evalStack.pop());
                        evalStack.push(ops[token].fn(a,b,c));
                    }
                    else if(ops[token].type === 'func') {
                        if(token === 'comm2') {
                             const b = getV(evalStack.pop());
                             const a = getV(evalStack.pop());
                             evalStack.push(ops[token].fn(a,b));
                        } else {
                            const a = getV(evalStack.pop());
                            evalStack.push(ops[token].fn(a));
                        }
                    } else {
                        // Binary ops
                        const b = getV(evalStack.pop());
                        const a = getV(evalStack.pop());
                        if(!a || !b) throw "Errore Sintassi";
                        evalStack.push(ops[token].fn(a, b));
                    }
                } else {
                    evalStack.push(token);
                }
            }
            return getV(evalStack[0]);
        }

        function setupGrid() {
            inputGrid.innerHTML = '';
            for(let i=0; i<=15; i++) {
                const l = i===0 ? '1' : 'e'+i;
                inputGrid.innerHTML += `
                    <div class="input-group" id="inp-grp-${i}">
                        <span style="font-size:10px; color:#666; width:25px; text-align:center;">${l}</span>
                        <input class="num-input" data-idx="${i}" value="0">
                    </div>`;
            }
            updateGridVisibility();
        }

        function updateGridVisibility() {
            const limit = parseInt(calcAlgSelect.value);
            for(let i=0; i<=15; i++) {
                const el = document.getElementById(`inp-grp-${i}`);
                if(i <= limit) el.classList.remove('hidden');
                else el.classList.add('hidden');
            }
        }

        function saveVar(varName) {
            const inputs = document.querySelectorAll('#input-grid input');
            inputs.forEach(inp => { storedVars[varName][parseInt(inp.dataset.idx)] = parseFloat(inp.value.replace(',', '.')) || 0; });
        }
        function setGrid(vector) {
            const inputs = document.querySelectorAll('#input-grid input');
            inputs.forEach(inp => { inp.value = vector[parseInt(inp.dataset.idx)]; });
        }
        function switchVar(newVar) {
            saveVar(currentVar);
            document.querySelectorAll('.var-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.var-tab[data-var="${newVar}"]`).classList.add('active');
            currentVar = newVar; setGrid(storedVars[newVar]);
        }
        document.querySelectorAll('.var-tab').forEach(tab => tab.addEventListener('click', () => switchVar(tab.dataset.var)));
        document.getElementById('btn-grid-clear').addEventListener('click', () => { setGrid(createZeroVector()); saveVar(currentVar); });
        document.getElementById('btn-grid-rand').addEventListener('click', () => {
            const limit = parseInt(calcAlgSelect.value);
            const v = createZeroVector();
            for(let i=0; i<=limit; i++) v[i] = Math.floor(Math.random()*21) - 10;
            setGrid(v); saveVar(currentVar);
        });
        calcAlgSelect.addEventListener('change', updateGridVisibility);

        window.calcInput = function(val) { document.getElementById('expression-display').value += val; };
        const historyOverlay = document.getElementById('history-overlay');
        const toggleHistoryBtn = document.getElementById('toggle-history-btn');
        toggleHistoryBtn.addEventListener('click', () => { historyOverlay.classList.toggle('open'); toggleHistoryBtn.classList.toggle('active'); });

        window.calcAction = function(action) {
            const disp = document.getElementById('expression-display');
            const resDisp = document.getElementById('result-display'); 
            if(action === 'clear') { disp.value = ''; resDisp.innerText = '0'; }
            if(action === 'back') disp.value = disp.value.slice(0, -1);
            if(action === 'eval') {
                saveVar(currentVar); 
                try {
                    const res = evaluateExpression(disp.value);
                    const ansId = storedAns.length + 1;
                    storedAns.push(res);
                    
                    const formatVec = (v) => {
                        let s = []; let allZero = true;
                        v.forEach((val, i) => {
                            if(Math.abs(val) > 0.001) {
                                allZero = false;
                                let term = (val < 0 ? "-" : "+") + Math.abs(parseFloat(val.toFixed(3)));
                                if(i > 0) term += "e<sub>" + i + "</sub>"; // FIX VISUALIZZAZIONE
                                s.push(term);
                            }
                        });
                        if(allZero) return "0";
                        let str = s.join(' ');
                        if(str.startsWith('+')) str = str.substring(1);
                        return str;
                    };

                    const resString = formatVec(res);
                    resDisp.innerHTML = "= " + resString; // Use innerHTML for subscripts

                    const log = document.getElementById('calc-log');
                    if(log.children.length === 1 && log.children[0].innerText.includes('Nessun')) log.innerHTML = '';
                    const entry = document.createElement('div');
                    entry.className = 'log-entry';
                    entry.innerHTML = `<div class="log-expr">Ans${ansId}: ${disp.value}</div><div class="log-res">= ${resString}</div>`;
                    entry.addEventListener('click', () => { disp.value += `Ans${ansId}`; historyOverlay.classList.remove('open'); toggleHistoryBtn.classList.remove('active'); });
                    log.prepend(entry);
                } catch(e) { resDisp.innerText = "Err"; console.error(e); alert("Errore: " + e); }
            }
        };

        document.getElementById('btn-clear-log').addEventListener('click', () => {
            document.getElementById('calc-log').innerHTML = '<div style="text-align:center; color:#555; margin-top:20px; font-size:12px;">Nessun calcolo recente</div>';
            storedAns = [];
        });

        function openCalculator() { calcModal.classList.add('active'); calcAlgSelect.value = currentAlgState; updateGridVisibility(); }
        calcToggle.addEventListener('click', openCalculator);
        calcClose.addEventListener('click', () => calcModal.classList.remove('active'));
        setupGrid();

        window.addEventListener('resize', () => {
            const w = container.clientWidth; const h = container.clientHeight;
            camera.aspect = w / h; camera.updateProjectionMatrix(); renderer.setSize(w, h); labelRenderer.setSize(w, h);
        });
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            if (!animParams.paused) animParams.customTime += delta * animParams.speed;
            animatedMaterials.forEach(mat => mat.uniforms.customTime.value = animParams.customTime);
            if(starField.visible) { starField.rotation.y += 0.0003; }
            controls.update();
            renderer.render(scene, camera);
            labelRenderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>